import React, { useState, useEffect, useRef } from 'react';
import { 
  Github, 
  ExternalLink, 
  Server, 
  Terminal, 
  Mail, 
  Cpu, 
  ShieldCheck,
  Disc,
  Code2,
  Globe,
  Zap,
  LayoutGrid,
  ChevronRight,
  ArrowUpRight
} from 'lucide-react';
import { motion } from 'framer-motion';

// --- Components ---

const SpotlightCard = ({ children, className = "", href = null }) => {
  const divRef = useRef(null);
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [opacity, setOpacity] = useState(0);

  const handleMouseMove = (e) => {
    if (!divRef.current) return;
    const rect = divRef.current.getBoundingClientRect();
    setPosition({ x: e.clientX - rect.left, y: e.clientY - rect.top });
  };

  const handleFocus = () => {
    setOpacity(1);
  };

  const handleBlur = () => {
    setOpacity(0);
  };

  const handleMouseEnter = () => {
    setOpacity(1);
  };

  const handleMouseLeave = () => {
    setOpacity(0);
  };

  const Component = href ? 'a' : 'div';
  const props = href ? { href, target: "_blank", rel: "noreferrer" } : {};

  return (
    <Component
      ref={divRef}
      onMouseMove={handleMouseMove}
      onFocus={handleFocus}
      onBlur={handleBlur}
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
      className={`relative overflow-hidden rounded-3xl border border-white/10 bg-zinc-900/50 px-8 py-8 shadow-2xl transition-colors hover:border-white/20 ${className}`}
      {...props}
    >
      <div
        className="pointer-events-none absolute -inset-px opacity-0 transition duration-300"
        style={{
          opacity,
          background: `radial-gradient(600px circle at ${position.x}px ${position.y}px, rgba(99,102,241,0.15), transparent 40%)`,
        }}
      />
      <div className="relative h-full flex flex-col">{children}</div>
    </Component>
  );
};

const Badge = ({ children, color = "indigo" }) => {
  const colors = {
    indigo: "bg-indigo-500/10 text-indigo-400 border-indigo-500/20",
    emerald: "bg-emerald-500/10 text-emerald-400 border-emerald-500/20",
    amber: "bg-amber-500/10 text-amber-400 border-amber-500/20",
    rose: "bg-rose-500/10 text-rose-400 border-rose-500/20",
    red: "bg-red-500/10 text-red-400 border-red-500/20",
    blue: "bg-blue-500/10 text-blue-400 border-blue-500/20",
    cyan: "bg-cyan-500/10 text-cyan-400 border-cyan-500/20",
  };
  return (
    <span className={`px-3 py-1 rounded-full text-xs font-medium border ${colors[color]} flex items-center gap-1.5 w-fit`}>
      <span className="relative flex h-2 w-2">
        <span className={`absolute inline-flex h-full w-full rounded-full opacity-75 ${color === 'red' ? 'bg-red-400' : 'animate-ping bg-' + color.split('-')[0] + '-400'}`}></span>
        <span className={`relative inline-flex rounded-full h-2 w-2 bg-${color.split('-')[0]}-500`}></span>
      </span>
      {children}
    </span>
  );
};

const TechIcon = ({ icon: Icon, label }) => (
  <div className="flex items-center gap-2 text-zinc-400 bg-white/5 px-4 py-2 rounded-xl border border-white/5 hover:border-white/10 hover:bg-white/10 transition-all">
    <Icon size={16} />
    <span className="text-sm font-medium">{label}</span>
  </div>
);

// --- Main Application ---

const App = () => {
  const [mounted, setMounted] = useState(false);
  const [activeSection, setActiveSection] = useState('home');
  // State for live stats with fallback values
  const [liveStats, setLiveStats] = useState({
    servers: "40.9k",
    users: "38.7k"
  });

  useEffect(() => {
    setMounted(true);
    
    // Fetch live stats
    const fetchStats = async () => {
      try {
        const targetUrl = 'https://earn.freezehost.pro/latest-server';
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&disableCache=true&t=${timestamp}`;
        
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error('Proxy response was not ok');
        
        const wrapperData = await response.json();
        // The proxy returns the actual API response inside the 'contents' string
        // We parse that inner string to get the real JSON object: {"server_id":..., "user_id":...}
        const data = JSON.parse(wrapperData.contents);
        
        const formatNumber = (num) => {
          if (!num) return null;
          if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'k';
          }
          return num.toString();
        };

        // CORRECTED: extracting the keys based on your API structure (server_id, user_id)
        const serverCount = data.server_id;
        const userCount = data.user_id;

        if (serverCount || userCount) {
          setLiveStats(prev => ({
            servers: serverCount ? formatNumber(serverCount) : prev.servers,
            users: userCount ? formatNumber(userCount) : prev.users
          }));
        }
      } catch (error) {
        console.warn("Live stats fetch failed, using cached values.");
      }
    };

    fetchStats();
    
    // Intersection Observer for scroll spy
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          setActiveSection(entry.target.id);
        }
      });
    }, { threshold: 0.5 });

    document.querySelectorAll('section').forEach(section => observer.observe(section));
    return () => observer.disconnect();
  }, []);

  const scrollTo = (id) => {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth' });
  };

  const gridItemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.5, ease: "easeOut" } }
  };

  return (
    <div className={`min-h-screen bg-black text-zinc-100 font-sans selection:bg-indigo-500/30 selection:text-indigo-200 ${mounted ? 'opacity-100' : 'opacity-0'} transition-opacity duration-1000`}>
      
      {/* Dynamic Background Noise & Gradients */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 brightness-100 contrast-150 mix-blend-overlay"></div>
        <div className="absolute top-[-10%] left-[-10%] w-[800px] h-[800px] bg-indigo-900/20 rounded-full blur-[120px] opacity-40" />
        <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-blue-900/10 rounded-full blur-[120px] opacity-40" />
      </div>

      {/* Floating Dynamic Island Nav - UPDATED with Sliding Animation */}
      <nav className="fixed top-6 left-1/2 -translate-x-1/2 z-50">
        <div className="flex items-center gap-1 bg-zinc-900/80 backdrop-blur-xl border border-white/10 p-1.5 rounded-full shadow-2xl shadow-black/50">
          {[
            { id: 'home', icon: LayoutGrid, label: 'Home' },
            { id: 'work', icon: Cpu, label: 'Work' },
            { id: 'stats', icon: Zap, label: 'Stats' },
            { id: 'contact', icon: Mail, label: 'Contact' }
          ].map((item) => (
            <button
              key={item.id}
              onClick={() => scrollTo(item.id)}
              className={`relative px-4 py-2 rounded-full text-sm font-medium transition-colors duration-300 flex items-center gap-2 ${
                activeSection === item.id 
                  ? 'text-white' 
                  : 'text-zinc-500 hover:text-zinc-300 hover:bg-white/5'
              }`}
            >
              {activeSection === item.id && (
                <motion.div
                  layoutId="active-pill"
                  className="absolute inset-0 bg-white/10 rounded-full shadow-inner"
                  transition={{ type: "spring", stiffness: 300, damping: 30 }}
                  style={{ borderRadius: 9999 }}
                />
              )}
              <span className="relative z-10 flex items-center gap-2">
                <item.icon size={16} />
                <span className="hidden sm:inline">{item.label}</span>
              </span>
            </button>
          ))}
        </div>
      </nav>

      <main className="relative z-10 max-w-7xl mx-auto px-6 pt-32 pb-20">
        
        {/* HERO SECTION - Bento Grid Layout */}
        <section id="home" className="space-y-6 mb-32">
          
          <motion.div 
            initial={{ opacity: 0, y: -20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8, ease: "easeOut" }}
            className="flex flex-col md:flex-row items-start md:items-end justify-between gap-6 mb-8"
          >
            <div>
              <div className="flex items-center gap-3 mb-4">
                <div className="h-12 w-12 rounded-full overflow-hidden border-2 border-white/10 shadow-lg">
                  <img src="https://i.ibb.co/ZsFxdkQ/d075f8140e6c227ce55ed9caea97e36b.gif" alt="Sarvesh" className="h-full w-full object-cover" />
                </div>
                <div>
                  <h2 className="text-lg font-bold">Sarvesh Patki</h2>
                  <p className="text-zinc-500 text-sm">Administrator @ Coaderoasis & FreezeHost</p>
                </div>
              </div>
              <h1 className="text-5xl md:text-7xl font-bold tracking-tight text-white max-w-3xl leading-[1.1]">
                Building <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-indigo-400 animate-gradient bg-300%">resilient</span> cloud infrastructure.
              </h1>
            </div>
            <div className="flex gap-3">
               <a href="https://github.com/SarveshPatki" target="_blank" className="bg-white text-black hover:bg-zinc-200 px-6 py-3 rounded-full font-bold transition-all flex items-center gap-2">
                 <Github size={20} /> GitHub
               </a>
               <a href="#contact" className="bg-zinc-900 text-white border border-zinc-800 hover:bg-zinc-800 px-6 py-3 rounded-full font-bold transition-all flex items-center gap-2">
                 Contact
               </a>
            </div>
          </motion.div>

          {/* Grid */}
          <motion.div 
            variants={{ visible: { transition: { staggerChildren: 0.1 } } }}
            initial="hidden"
            animate="visible"
            className="grid grid-cols-1 lg:grid-cols-12 gap-4"
          >
            
            {/* Featured Card - Full Width */}
            <motion.div variants={gridItemVariants} className="lg:col-span-12">
              <SpotlightCard className="flex flex-col justify-between group cursor-default h-full">
                <div>
                  <Badge color="red">Not currently available for work</Badge>
                  <h3 className="text-2xl font-bold mt-4 mb-2">Full Stack Hosting</h3>
                  <p className="text-zinc-400 leading-relaxed max-w-2xl">
                    Specializing in Pterodactyl panels, Linux administration, and scalable server networks. I build and maintain the infrastructure that powers online communities.
                  </p>
                </div>
                <div className="mt-8 flex flex-col gap-4">
                  <div className="flex flex-wrap gap-2">
                    {['Linux', 'C', 'MySQL', 'Pterodactyl', 'Minecraft Server Dev'].map(tech => (
                      <span key={tech} className="text-xs font-mono bg-black/30 text-zinc-400 px-2 py-1 rounded border border-white/5">{tech}</span>
                    ))}
                  </div>
                  <div className="flex flex-wrap gap-2 text-xs text-zinc-500 font-mono">
                    <span>Currently learning:</span>
                    {['Docker', 'Python', 'Bash', 'Redis', 'Node.js'].map(tech => (
                      <span key={tech} className="bg-black/30 px-2 py-1 rounded border border-white/5">{tech}</span>
                    ))}
                  </div>
                </div>
              </SpotlightCard>
            </motion.div>

            {/* Currently Working At Card - Shared Width */}
            <motion.div variants={gridItemVariants} className="lg:col-span-12">
              <SpotlightCard className="bg-zinc-900/80 group h-full">
                <div className="mb-6">
                  <h3 className="text-lg font-bold text-white flex items-center gap-2">
                    <Cpu size={20} className="text-indigo-400" /> Currently Working At
                  </h3>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
                  
                  {/* Coaderoasis Block - GREEN */}
                  <a 
                    href="https://coderoasis.com/" 
                    target="_blank" 
                    rel="noreferrer" 
                    className="group/item relative bg-zinc-900/50 hover:bg-emerald-900/10 rounded-2xl p-6 border border-white/5 hover:border-emerald-500/30 transition-all duration-300 overflow-hidden flex flex-col"
                  >
                    <div className="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                    <div className="flex justify-between items-start relative z-10 mb-4">
                      <div className="p-2.5 bg-white/10 rounded-xl backdrop-blur-md">
                         <img src="https://i.ibb.co/8L7RcJJD/Whats-App-Image-2025-07-14-at-00-39-46-34f86e2c.jpg" alt="Coaderoasis Logo" className="h-6 w-6 rounded-full" />
                      </div>
                      <ArrowUpRight className="text-white/50 group-hover/item:text-emerald-300 group-hover/item:translate-x-1 group-hover/item:-translate-y-1 transition-all" />
                    </div>
                    <div className="relative z-10 mt-auto">
                      <div className="text-emerald-300 font-mono text-xs mb-1 group-hover/item:text-emerald-200 transition-colors">ADMINISTRATOR</div>
                      <h3 className="text-2xl font-bold text-white mb-1 group-hover/item:text-emerald-50 transition-colors">Coaderoasis</h3>
                      <p className="text-zinc-400 text-sm mb-4 group-hover/item:text-zinc-300 transition-colors">Tech articles covering Cybersecurity, Linux & Hosting.</p>
                      
                      {/* Topics Tags - Green Theme */}
                      <div className="flex flex-wrap gap-2">
                        {['Cryptography', 'Linux', 'Java', 'Python'].map(tag => (
                          <span key={tag} className="text-[10px] font-medium px-2 py-0.5 rounded bg-emerald-500/10 border border-emerald-500/10 text-emerald-300/80 group-hover/item:text-emerald-200 group-hover/item:border-emerald-500/30 transition-all">
                            {tag}
                          </span>
                        ))}
                        <span className="text-[10px] font-medium px-2 py-0.5 rounded bg-emerald-500/10 border border-emerald-500/10 text-emerald-300/80 group-hover/item:text-emerald-200 group-hover/item:border-emerald-500/30 transition-all">+6 more</span>
                      </div>
                    </div>
                  </a>

                  {/* FreezeHost Block - BLUE/CYAN */}
                  <a 
                    href="https://freezehost.pro/" 
                    target="_blank" 
                    rel="noreferrer" 
                    className="group/item relative bg-zinc-900/50 hover:bg-cyan-900/10 rounded-2xl p-6 border border-white/5 hover:border-cyan-500/30 transition-all duration-300 overflow-hidden flex flex-col"
                  >
                    <div className="absolute inset-0 bg-cyan-500/5 opacity-0 group-hover/item:opacity-100 transition-opacity duration-300"></div>
                    <div className="flex justify-between items-start relative z-10 mb-auto">
                       <div className="p-2.5 bg-cyan-500/10 rounded-xl">
                         <img src="https://i.ibb.co/5hS6W82g/405729d61aa764b1ae7042fa89aaad9f.png" alt="FreezeHost Logo" className="h-6 w-6 rounded-full" />
                       </div>
                       <div className="flex items-center gap-2">
                         <Badge color="cyan">Free Hosting</Badge>
                         <ArrowUpRight className="text-white/50 group-hover/item:text-cyan-300 group-hover/item:translate-x-1 group-hover/item:-translate-y-1 transition-all" />
                       </div>
                    </div>
                    <div className="relative z-10 mt-4">
                      <div className="text-cyan-300 font-mono text-xs mb-1 group-hover/item:text-cyan-200 transition-colors">ADMINISTRATOR</div>
                      <h3 className="text-xl font-bold text-white group-hover/item:text-cyan-50 transition-colors">FreezeHost</h3>
                      <p className="text-zinc-500 text-sm mt-1 group-hover/item:text-zinc-300 transition-colors">Nodes in NL (Self-hosted) & SG.</p>
                      <div className="mt-4 pt-3 border-t border-white/5 flex items-center justify-between text-xs text-zinc-400 font-mono">
                         <span>MSH SYSTEM</span>
                         <span className="text-emerald-400">ACTIVE</span>
                      </div>
                    </div>
                  </a>

                </div>
              </SpotlightCard>
            </motion.div>

          </motion.div>
        </section>

        {/* WORK / TIMELINE SECTION */}
        <section id="work" className="mb-32 max-w-4xl mx-auto">
           <div className="flex items-center gap-4 mb-12">
             <div className="h-px bg-zinc-800 flex-grow"></div>
             <h2 className="text-sm font-mono text-zinc-500 uppercase tracking-widest">Experience Record</h2>
             <div className="h-px bg-zinc-800 flex-grow"></div>
           </div>

           <div className="space-y-6">
              {[
                {
                  company: "Coaderoasis",
                  role: "Administrator",
                  year: "2024 - Present",
                  desc: "A technical publication covering Cryptography, Linux, and Software Dev. I manage the platform and its global Oracle-backed infrastructure.",
                  icon: ShieldCheck,
                  img: "https://i.ibb.co/8L7RcJJD/Whats-App-Image-2025-07-14-at-00-39-46-34f86e2c.jpg",
                  current: true,
                  link: "https://coderoasis.com/",
                  color: "text-emerald-400",
                  shadow: "shadow-[0_0_20px_rgba(16,185,129,0.15)]" // Green shadow
                },
                {
                  company: "FreezeHost",
                  role: "Administrator",
                  year: "2025 - Present",
                  desc: "Operating 2 active nodes (Netherlands self-hosted & Singapore provider). Implemented the MSH (Minecraft Server Hibernation) system.",
                  icon: Server,
                  img: "https://i.ibb.co/5hS6W82g/405729d61aa764b1ae7042fa89aaad9f.png",
                  current: true,
                  link: "https://freezehost.pro/",
                  color: "text-cyan-400",
                  shadow: "shadow-[0_0_20px_rgba(6,182,212,0.15)]" // Cyan shadow
                },
                {
                  company: "Independent Consultant",
                  role: "System Admin",
                  year: "2023 - 2024",
                  desc: "Managed deployments for various boutique hosting providers. Specialized in Pterodactyl.",
                  icon: Terminal,
                  current: false
                },
                {
                  company: "Netly.gg",
                  role: "Community Manager & Dev",
                  year: "2021 - 2023",
                  desc: "Scaled community to 13k+ users. Managed lifecycle for ~10k servers.",
                  icon: Globe,
                  img: "https://i.ibb.co/zHDSzZ4L/image.png",
                  current: false,
                  link: "https://netly.gg/"
                }
              ].map((job, idx) => (
                <div key={idx} className="group flex gap-6 p-6 rounded-2xl hover:bg-white/5 transition-all border border-transparent hover:border-white/5">
                  <div className={`mt-1 h-10 w-10 rounded-full flex items-center justify-center border border-white/10 bg-zinc-900 shrink-0 group-hover:scale-110 transition-transform overflow-hidden ${
                    job.current 
                      ? `${job.color} ${job.shadow}`
                      : 'text-zinc-500'
                  }`}>
                    {job.img ? (
                      <img src={job.img} alt={job.company} className="h-full w-full object-cover" />
                    ) : (
                      <job.icon size={18} />
                    )}
                  </div>
                  <div className="flex-grow">
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-2 gap-1">
                      <h3 className="text-lg font-bold text-zinc-200 group-hover:text-indigo-300 transition-colors">
                        {job.link ? (
                          <a href={job.link} target="_blank" rel="noreferrer" className="flex items-center gap-2 hover:underline decoration-indigo-500/50 underline-offset-4">
                            {job.company} <ExternalLink size={14} className="opacity-50" />
                          </a>
                        ) : (
                          job.company
                        )}
                      </h3>
                      <span className="text-xs font-mono text-zinc-500 bg-white/5 px-2 py-1 rounded">{job.year}</span>
                    </div>
                    <div className="text-sm font-medium text-zinc-400 mb-2">{job.role}</div>
                    <p className="text-zinc-500 text-sm leading-relaxed">{job.desc}</p>
                  </div>
                </div>
              ))}
           </div>
        </section>

        {/* STATS SECTION */}
        <section id="stats" className="mb-32">
          <div className="flex flex-col md:flex-row justify-between items-end mb-8 gap-4 px-2">
            <div>
               <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                 <Zap className="text-yellow-400" size={24} /> Current Network Scale
               </h2>
               <p className="text-zinc-400 mt-2">Live metrics across <span className="text-emerald-400 font-medium">Coaderoasis</span> & <span className="text-cyan-400 font-medium">FreezeHost</span>.</p>
            </div>
            <div className="hidden md:block h-px bg-zinc-800 w-full max-w-[200px] mb-2"></div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-px bg-zinc-800 rounded-3xl overflow-hidden border border-zinc-800">
             {[
               { label: "Total Servers", value: liveStats.servers, sub: "Live count" },
               { label: "Users Served", value: liveStats.users, sub: "Active userbase" },
               { label: "Active Nodes", value: "11+", sub: "Managed daily" },
               { label: "Uptime", value: "99%", sub: "SLA Maintained" },
             ].map((stat, i) => (
               <div key={i} className="bg-zinc-950 p-8 flex flex-col items-center text-center hover:bg-zinc-900/50 transition-colors group">
                 <div className="text-4xl md:text-5xl font-bold text-white mb-2 group-hover:scale-110 transition-transform duration-300 bg-clip-text text-transparent bg-gradient-to-b from-white to-zinc-500">
                   {stat.value}
                 </div>
                 <div className="text-zinc-300 font-medium">{stat.label}</div>
                 <div className="text-zinc-600 text-xs mt-1">{stat.sub}</div>
               </div>
             ))}
          </div>
        </section>

        {/* FOOTER / CONTACT */}
        <section id="contact" className="relative rounded-3xl overflow-hidden">
          <div className="absolute inset-0 bg-indigo-600/20 blur-3xl"></div>
          <div className="relative bg-zinc-900/80 backdrop-blur-2xl border border-white/10 rounded-3xl p-12 text-center overflow-hidden">
            
            <div className="max-w-2xl mx-auto space-y-8">
              <h2 className="text-4xl font-bold text-white">Let's build the future.</h2>
              <p className="text-zinc-400 text-lg">
                I'm always open to discussing new projects, creative ideas, or opportunities to be part of your visions.
              </p>
              
              <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                <a href="mailto:phonesarvesh95@gmail.com" className="w-full sm:w-auto px-8 py-4 bg-white text-black font-bold rounded-xl hover:bg-zinc-200 transition-all flex items-center justify-center gap-2">
                  <Mail size={20} /> Email Me
                </a>
                <a href="https://discord.com/users/741184115981680702" target="_blank" className="w-full sm:w-auto px-8 py-4 bg-[#5865F2] text-white font-bold rounded-xl hover:bg-[#4752C4] transition-all flex items-center justify-center gap-2">
                  <Disc size={20} /> Discord
                </a>
              </div>
            </div>

            {/* Footer Bottom */}
            <div className="mt-20 pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between items-center text-zinc-500 text-sm">
              <p>Â© 2025 Sarvesh Patki.</p>
              <div className="flex gap-6 mt-4 md:mt-0">
                <a href="#" className="hover:text-white transition-colors">Twitter</a>
                <a href="https://github.com/SarveshPatki" className="hover:text-white transition-colors">GitHub</a>
                <a href="#" className="hover:text-white transition-colors">LinkedIn</a>
              </div>
            </div>

          </div>
        </section>

      </main>
    </div>
  );
};

export default App;
